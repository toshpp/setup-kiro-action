name: Test Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-ubuntu-x64:
    name: Test on Ubuntu x64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test action
        uses: ./
        id: kiro

      - name: Verify installation
        run: |
          echo "Kiro version: ${{ steps.kiro.outputs.kiro-version }}"
          echo "Kiro path: ${{ steps.kiro.outputs.kiro-path }}"
          kiro-cli-chat --version

      - name: Test kiro-cli-chat command
        run: |
          which kiro-cli-chat
          kiro-cli-chat --help

  test-cache:
    name: Test caching
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: First run (cache miss)
        uses: ./

      - name: Remove binaries
        run: rm -f ~/.local/bin/kiro-cli-chat

      - name: Second run (cache hit)
        uses: ./

      - name: Verify cache worked
        run: |
          kiro-cli-chat --version

  test-sigv4-config:
    name: Test SIGV4 configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test with SIGV4 enabled
        uses: ./
        with:
          enable-sigv4: true
          aws-region: ca-central-1

      - name: Verify SIGV4 environment variables
        run: |
          if [ "$AMAZON_Q_SIGV4" != "true" ]; then
            echo "ERROR: AMAZON_Q_SIGV4 not set correctly"
            exit 1
          fi
          if [ "$AWS_REGION" != "ca-central-1" ]; then
            echo "ERROR: AWS_REGION not set correctly"
            exit 1
          fi
          echo "SIGV4 configuration verified"
          kiro-cli-chat --version

  test-checksum-verification:
    name: Test SHA256 verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test with verification enabled
        uses: ./
        with:
          verify-checksum: true

      - name: Verify installation
        run: |
          kiro-cli-chat --version
          echo "Checksum verification passed"

  test-platform-check:
    name: Test platform check (should skip on macOS)
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test action (should fail gracefully)
        id: test
        uses: ./
        continue-on-error: true

      - name: Verify expected failure
        if: steps.test.outcome == 'failure'
        run: |
          echo "Expected failure on macOS - PASSED"
